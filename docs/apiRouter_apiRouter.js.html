<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: apiRouter/apiRouter.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: apiRouter/apiRouter.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

require('dotenv').config();

const request = require('request');
const express = require('express');
const router = express.Router();


const querystring = require('querystring');
const SpotifyWebApi = require('spotify-web-api-node');
const moodApp = require('../app.js');

router.get('/', loadHome);
router.get('/login', oauth);
router.get('/callback', getToken);
router.get('/nowplaying', getCurrentlyPlaying);
router.get('/colorize', colorize);

/**
 * 
 * @param {*} req 
 * @param {*} res 
 * If user is logged in, returns
 * json object with spotify profile
 * information
 */
function loadHome(req, res) {

  return spotifyApi.getMe()
    .then(me => {
      res.status(200).send(me.body);
    })
    .catch(console.error);
};

/**
 * 
 * @param {*} req 
 * @param {*} res 
 * this function performs a POST to
 * the spotify api/token url and
 * redirects to the home route with
 * a new access token
 */
function getToken(req, res) {
  let code = req.query.code || null;
  let authOptions = {
    url: 'https://accounts.spotify.com/api/token',
    form: {
      code: code,
      redirect_uri,
      grant_type: 'authorization_code'
    },
    headers: {
      'Authorization': 'Basic ' + (new Buffer(
        process.env.SPOTIFY_CLIENT_ID + ':' + process.env.SPOTIFY_CLIENT_SECRET
      ).toString('base64'))
    },
    json: true
  }
  request.post(authOptions, function (error, response, body) {
    access_token = body.access_token
     let uri = 'http://localhost:3000/';
    res.redirect(uri + '?access_token=' + access_token);
  })
};


function oauth(req, res, next) {
  const client_id = process.env.SPOTIFY_CLIENT_ID;
  const redirect_uri = process.env.REDIRECT_URI;

  const scope = 'user-read-private user-read-email user-read-currently-playing user-read-playback-state';
  res.redirect('https://accounts.spotify.com/authorize?' +
    querystring.stringify({
      response_type: 'code',
      client_id: client_id,
      scope: scope,
      redirect_uri: redirect_uri,
    }))
};

/**
 * 
 * @param {*} req 
 * @param {*} res 
 * runs getMood function and
 * sends response as a single
 * object
 */
function getCurrentlyPlaying(req, res) {
  getMood()
    .then(mood => {
      let moodObj = { mood: mood }
      res.status(200).send(moodObj);
    });
};

/**
 * 
 * @param {*} req 
 * @param {*} res 
 * runs getMood function, passes
 * its return value into the convertMoodToRGB
 * function and sends the result
 */
function colorize(req, res) {
  return getMood()
    .then(mood => {
      let colorSet = moodApp.convertMoodToRGB(mood)
      res.status(200).send(colorSet)
    });
};

/**
 * makes multiple calls to the spotify
 * api in order to retrieve the value of the valence
 */
function getMood() {

  const spotifyApi = new SpotifyWebApi({
    accessToken: process.env.ACCESS_TOKEN,
  });

  return spotifyApi.getMyCurrentPlayingTrack()
    .then(data => {
      let id = data.body.item.id;
      console.log('track name', data.body.item.name);
      return spotifyApi.getAudioFeaturesForTrack(id)
    }).then(data => {
      let valence = Math.round((data.body.valence * 10));
      console.log('mood score', valence);
      return valence;
    }).catch(err => {
      console.log(err);
    })
};

// setInterval(getMood, 5000);

module.exports = router;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#colorize">colorize</a></li><li><a href="global.html#convertMoodToRGB">convertMoodToRGB</a></li><li><a href="global.html#getCurrentlyPlaying">getCurrentlyPlaying</a></li><li><a href="global.html#getMood">getMood</a></li><li><a href="global.html#getToken">getToken</a></li><li><a href="global.html#loadHome">loadHome</a></li><li><a href="global.html#range">range</a></li><li><a href="global.html#validateParam">validateParam</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Aug 29 2019 17:32:11 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
